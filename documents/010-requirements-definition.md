# 開発目的

就職活動のためのデモンストレーションとして簡単なWebアプリを作成する。
下記を示すことが目的。
- 簡単なWebアプリのコーディング技術
- 簡単なデータベース設計力
- 継続的な開発に必要な環境の構築技術
- インフラ周りの最低限の知識
  - 新規技術に対するキャッチアップの姿勢
- 基本的なセキュリティ意識

要望の例として、下記を設定する。

ユーザからの製品に関する問い合わせをメールで個別に行っている。
対話形式のWebアプリにすることによって、どの問い合わせが対応中でどの問い合わせが対応終了しているのかわかりやすくしたい。

# 用語

- 一般ユーザ: 問い合わせを行うユーザ
- 管理ユーザ: 問い合わせに回答するユーザ。問い合わせをクローズする権限を持つ
- メッセージ: ひとまとまりの問い合わせ文もしくは返答文
- スレッド: 一連の問い合わせのやり取り。一般ユーザは複数のオープンなスレッドを持つことができる
- オープン: スレッドの開始
- クローズ: スレッドの終了

# 機能要件

## スコープ内

- 一般ユーザはユーザ登録できる
- 一般ユーザはスレッドをオープンできる
- 一般ユーザは自分のスレッドのみを閲覧できる
- 一般ユーザは自分のオープンなスレッドにのみメッセージを投稿できる
- 一般ユーザはクローズされたスレッドにメッセージを投稿できない
- 一般ユーザは自分の問い合わせスレッドをオープン・クローズに関わらず閲覧できる
- 管理ユーザは任意のオープンなスレッドにメッセージを投稿できる
- 管理ユーザは任意のオープンなスレッドをクローズできる
- 管理ユーザはスレッドを以下の順番で時系列降順に表示することができる
  - オープンかつ最新のメッセージが一般ユーザからのスレッド
  - オープンかつ最新のメッセージが管理ユーザからのスレッド
  - クローズされたスレッド

## スコープ外

- スレッド一覧画面・スレッド画面のリアルタイム更新
- スレッド参加者の指定・限定
- クローズされたスレッドの再オープン
  - 別スレッドとして対応
- 画像などのファイルを含むメッセージ
- Webアプリ側からの管理ユーザ登録
  - 管理ユーザはシステム管理者が手動で作成する

# 可用性

- 常時稼働を目標とする
- 復旧時間は保証しない
- 障害時は下記で対応する
  1. 前バージョンへのロールバック
  1. DBの直近バックアップ時点へのリストア
- RPOは最大24時間とする

# セキュリティ

## 認証・認可

- ユーザ登録・ログイン・ログアウト以外は認証必須
- 一般ユーザは自分のスレッドのみ閲覧・投稿できる
- 管理ユーザはすべてのスレッドを閲覧でき、投稿・クローズできる

## レート制限

- 下記操作に対してクライアントIP単位でのレート制限を行う
  - ログイン
  - スレッドのオープン
  - メッセージ送信
  - スレッドのクローズ
- 30回/分を閾値とする
- 超過時はリクエストを拒否する
- 最後の操作から1分経過後に再度操作可能になる

## 入出力

- ユーザ入力を適切に取り扱い、SQLインジェクション・XSSへの対策をする
- データベースの内容が変化する操作にはトークンを紐付け、CSRFへの対策をする

# 動作環境

- 対応ブラウザ: Chrome/Firefox/Safariの最新世代
- タイムゾーン: Asia/Tokyo
- 文字コード: UTF-8

# 運用・保守

## 監視・アラート

- 401/403/5xxについて監視し、閾値を超えた場合はメールでシステム管理者に通知する
  - 401: 60回/分
  - 403: 30回/分
  - 5xx: 10回/分

## 追跡可能性

- リクエストごとにIDを発行し、ログに記載する

# 受け入れ条件

1. 認証が必要なページに未認証でアクセスするとログイン画面が表示される
1. 一般ユーザは自分のスレッド一覧を表示できる
1. 一般ユーザが自分のスレッドをオープンでき、初回メッセージが保存される
1. 一般ユーザが自分のスレッドの内容をオープン・クローズに関わらず閲覧できる
1. 一般ユーザが自分のオープンなスレッドにメッセージを投稿できる
1. 一般ユーザが自分のクローズされたスレッドにメッセージを投稿できない
1. 一般ユーザによる自分のスレッド以外のスレッドの閲覧が拒否される
1. 管理ユーザが下記の優先度をもとに時系列降順にソートされたスレッド一覧を表示できる
  - オープンかつ最新のメッセージが一般ユーザのもの
  - オープンかつ最新のメッセージが管理ユーザのもの
  - クローズされたスレッド
1. 管理ユーザは任意のスレッドの内容を閲覧できる
1. 管理ユーザは任意のオープンなスレッドにメッセージを投稿できる
1. 管理ユーザは任意のオープンなスレッドをクローズできる
1. 同一IPから対象となる操作が1分以内に30回を超えた場合、そのIPからの操作を拒否する
1. レート制限により拒否されたIPは、最後の操作から1分経過後に再度操作可能になる
1. トークン無しでのメッセージ送信が拒否される
1. `<script>`を含むメッセージを投稿しても実行されない
1. 401/403/5xxの件数が閾値を超えた場合にシステム管理者に通知される
1. 全リクエストのログにIDが付与される
